# -*- makefile -*-

# Adjust these to reflect where you've installed gnulib.
GNULIB = ../gnulib
GNULIB_TOOL = $(GNULIB)/gnulib-tool

GNULIB_MODULES = \
	alloca \
	alloca-opt \
	assert \
	c-ctype \
	c-strtod \
	exit \
	full-read \
	full-write \
	gethostname \
	getline \
	getlogin_r \
	getopt \
	gettext \
	intprops \
	linebreak \
	memcasecmp \
	memchr \
	memcmp \
	memmem \
	memmove \
	memset \
	progname \
	readlink \
	restrict \
	snprintf \
	stat-macros \
	stdarg \
	stdbool \
	stdint \
	stpcpy \
	strcase \
	strcspn \
	strerror \
	strftime \
	strsep \
	strstr \
	strtod \
	strtok_r \
	strtol \
	strtoul \
	unistd \
	vsnprintf \
	xalloc \
	xalloc-die \
	xreadlink \
	xvasprintf

all: po/POTFILES.in
	test -d m4 || mkdir m4
	touch m4/Makefile.am
	$(GNULIB_TOOL) --import --no-changelog --m4-base=gl/m4 \
		--source-base=gl --lib=libgl --tests-base=tests \
		--import $(GNULIB_MODULES)
	autoreconf --install

gettextize:
	test -d m4 || mkdir m4
	touch m4/Makefile.am
	gettextize -f -c --intl --no-changelog

po/POTFILES.in:
	for f in `find src -name \*.[qc] ! -name .\* -print \
		  | sed 's/\.[qc]$$//'`; do \
		if test $$f = src/libpspp/version; then continue; fi;	  \
		if test -e $$f.q; then echo $$f.q; else echo $$f.c; fi	  \
	done | sort | uniq > $@.tmp
	if test ! -e $@ || ! cmp -s $@.tmp $@; then mv $@.tmp $@; fi
	rm -f $@.tmp

check: all
	rm -rf _check
	mkdir _check
	cd _check && ../configure $(CONFIGUREFLAGS)
	cd _check && make distcheck
	rm -rf _check

_build: all
	test -d _build || mkdir _build
	cd _build && ../configure $(CONFIGUREFLAGS)

PO_FILES = po/ChangeLog po/Makefile po/Makefile.in po/Makefile.in.in	\
po/POTFILES po/POTFILES.in po/Rules-quot po/boldquot.sed		\
po/cat-id-tbl.c po/en@boldquot.header po/en@quot.header			\
po/insert-header.sin po/quot.sed po/remove-potcdate.sin po/stamp-po	\
po/Makevars.template

clean:
	rm -f config.sub config.guess config.rpath
	rm -f ABOUT-NLS
	rm -fr autom4te.cache
	rm -f aclocal.m4
	rm -f missing mkinstalldirs
	rm -f install-sh
	rm -f configure Makefile 
	rm -f depcomp
	rm -rf intl gl
	rm -f m4/*.m4
	rm -f $(PO_FILES)
	rm -f mdate-sh texinfo.tex
	rm -f doc/stamp-vti
	rm -f config.h.in~
	find . -name Makefile.in -exec rm -f {} \; 
	rm -f compile

.PHONY: all gettextize potfiles clean
